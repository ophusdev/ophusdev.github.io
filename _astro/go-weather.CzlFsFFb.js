import{m as B,u as $}from"./hoisted.C9AmvHCV.js";import{a as h,c as _,r as f,m as w}from"./render-template.BEYdpJPm.js";import{A as F,a as E,b as D,E as O,c as S,i as b,d as M,e as G,D as P,_ as R,f as L,g as I}from"./astro/assets-service.UPL31UwL.js";const q="4.2.4";function H(){return n=>{if(typeof n=="string")throw new F({...E,message:E.message(JSON.stringify(n))});let s=[...Object.values(n)];if(s.length===0)throw new F({...D,message:D.message(JSON.stringify(n))});return Promise.all(s.map(a=>a()))}}function T(e){return{site:new URL(e),generator:`Astro v${q}`,glob:H()}}function c(e={},n,{class:s}={}){let a="";s&&(typeof e.class<"u"?e.class+=` ${s}`:typeof e["class:list"]<"u"?e["class:list"]=[e["class:list"],s]:e.class=s);for(const[t,o]of Object.entries(e))a+=h(o,t,!0);return B(a)}async function N(){if(!globalThis?.astroAsset?.imageService){const{default:e}=await R(async()=>{const{default:n}=await import("./astro/assets-service.UPL31UwL.js").then(s=>s.s);return{default:n}},[]).catch(n=>{const s=new F(L);throw s.cause=n,s});return globalThis.astroAsset||(globalThis.astroAsset={}),globalThis.astroAsset.imageService=e,e}return globalThis.astroAsset.imageService}async function J(e,n){if(!e||typeof e!="object")throw new F({...O,message:O.message(JSON.stringify(e))});if(typeof e.src>"u")throw new F({...S,message:S.message(e.src,"undefined",JSON.stringify(e))});const s=await N(),a={...e,src:typeof e.src=="object"&&"then"in e.src?(await e.src).default??await e.src:e.src},t=b(a.src)?a.src.fsPath:a.src,o=b(a.src)?a.src.clone??a.src:a.src;a.src=o;const i=s.validateOptions?await s.validateOptions(a,n):a,l=s.getSrcSet?await s.getSrcSet(i,n):[];let p=await s.getURL(i,n),d=await Promise.all(l.map(async r=>({transform:r.transform,url:await s.getURL(r.transform,n),descriptor:r.descriptor,attributes:r.attributes})));if(M(s)&&globalThis.astroAsset.addStaticImage&&!(G(i.src)&&p===i.src)){const r=s.propertiesToHash??P;p=globalThis.astroAsset.addStaticImage(i,r,t),d=l.map(u=>({transform:u.transform,url:globalThis.astroAsset.addStaticImage(u.transform,r,t),descriptor:u.descriptor,attributes:u.attributes}))}return{rawOptions:a,options:i,src:p,srcSet:{values:d,attribute:d.map(r=>`${r.url} ${r.descriptor}`).join(", ")},attributes:s.getHTMLAttributes!==void 0?await s.getHTMLAttributes(i,n):{}}}const j=T("https://ophusdev.github.io"),U=_(async(e,n,s)=>{const a=e.createAstro(j,n,s);a.self=U;const t=a.props;if(t.alt===void 0||t.alt===null)throw new F(I);typeof t.width=="string"&&(t.width=parseInt(t.width)),typeof t.height=="string"&&(t.height=parseInt(t.height));const o=await m(t),i={};return o.srcSet.values.length>0&&(i.srcset=o.srcSet.attribute),f`${w()}<img${h(o.src,"src")}${c(i)}${c(o.attributes)}>`},"/home/io/Documents/code/ophusdev-blog/node_modules/astro/components/Image.astro",void 0),K=T("https://ophusdev.github.io"),Y=_(async(e,n,s)=>{const a=e.createAstro(K,n,s);a.self=Y;const t=["webp"],o="png",i=["gif","svg","jpg","jpeg"],{formats:l=t,pictureAttributes:p={},fallbackFormat:d,...r}=a.props;if(r.alt===void 0||r.alt===null)throw new F(I);const u=await Promise.all(l.map(async C=>await m({...r,format:C,widths:r.widths,densities:r.densities})));let v=d??o;!d&&b(r.src)&&i.includes(r.src.format)&&(v=r.src.format);const y=await m({...r,format:v,widths:r.widths,densities:r.densities}),x={},A={};return r.sizes&&(A.sizes=r.sizes),y.srcSet.values.length>0&&(x.srcset=y.srcSet.attribute),f`${w()}<picture${c(p)}> ${Object.entries(u).map(([C,g])=>{const k=r.densities||!r.densities&&!r.widths?`${g.src}${g.srcSet.values.length>0?", "+g.srcSet.attribute:""}`:g.srcSet.attribute;return f`<source${h(k,"srcset")}${h("image/"+g.options.format,"type")}${c(A)}>`})} <img${h(y.src,"src")}${c(x)}${c(y.attributes)}> </picture>`},"/home/io/Documents/code/ophusdev-blog/node_modules/astro/components/Picture.astro",void 0),Q={service:{entrypoint:"astro/assets/services/sharp",config:{}},domains:["webmention.io"],remotePatterns:[]};new URL("file:///home/io/Documents/code/ophusdev-blog/dist/");const m=async e=>await J(e,Q),V={src:"/_astro/current_weather.DXuqd3rX.png",width:1864,height:1056,format:"png"},W={src:"/_astro/daily_weather.CYgY-JtO.png",width:1864,height:1056,format:"png"},X={src:"/_astro/hourly_weather.BsL5mwTM.png",width:1864,height:2804,format:"png"},Z={src:"/_astro/pm_and_pollen.DrfbbC6o.png",width:1864,height:1816,format:"png"},ee=async function(e){const n={};{const s=new RegExp('__ASTRO_IMAGE_="([^"]*\\.\\./\\.\\./assets/go-weather/current_weather\\.png[^"]*)"',"g");let a,t=0;for(;(a=s.exec(e))!==null;){const o="../../assets/go-weather/current_weather.png_"+t,i=JSON.parse(a[1].replace(/&#x22;/g,'"')),{src:l,...p}=i;n[o]=await m({src:V,...p}),t++}}{const s=new RegExp('__ASTRO_IMAGE_="([^"]*\\.\\./\\.\\./assets/go-weather/daily_weather\\.png[^"]*)"',"g");let a,t=0;for(;(a=s.exec(e))!==null;){const o="../../assets/go-weather/daily_weather.png_"+t,i=JSON.parse(a[1].replace(/&#x22;/g,'"')),{src:l,...p}=i;n[o]=await m({src:W,...p}),t++}}{const s=new RegExp('__ASTRO_IMAGE_="([^"]*\\.\\./\\.\\./assets/go-weather/hourly_weather\\.png[^"]*)"',"g");let a,t=0;for(;(a=s.exec(e))!==null;){const o="../../assets/go-weather/hourly_weather.png_"+t,i=JSON.parse(a[1].replace(/&#x22;/g,'"')),{src:l,...p}=i;n[o]=await m({src:X,...p}),t++}}{const s=new RegExp('__ASTRO_IMAGE_="([^"]*\\.\\./\\.\\./assets/go-weather/pm_and_pollen\\.png[^"]*)"',"g");let a,t=0;for(;(a=s.exec(e))!==null;){const o="../../assets/go-weather/pm_and_pollen.png_"+t,i=JSON.parse(a[1].replace(/&#x22;/g,'"')),{src:l,...p}=i;n[o]=await m({src:Z,...p}),t++}}return n};async function se(e){return ee(e).then(n=>e.replaceAll(/__ASTRO_IMAGE_="([^"]+)"/gm,(s,a)=>{const t=JSON.parse(a.replace(/&#x22;/g,'"')),o=t.src+"_"+t.index;n[o].srcSet&&n[o].srcSet.values.length>0&&(n[o].attributes.srcset=n[o].srcSet.attribute);const{index:i,...l}=n[o].attributes;return c({src:n[o].src,...l})}))}const z=await se(`<h2 id="openmeteogo">Openmeteogo</h2>
<p>Nelle ultime settimane mi sono immerso nell’utilizzo di Go per sviluppare una libreria per <a href="http://open-meteo.com" rel="nofollow, noopener, noreferrer" target="_blank">open-meteo.com</a>, ora disponibile su <a href="https://github.com/ophusdev/openmeteogo" rel="nofollow, noopener, noreferrer" target="_blank">Github</a> che ho nominato openmeteogo.</p>
<p>Come primo approccio a Go, mi sono affidato interamente a <a href="https://gobyexample.com/" rel="nofollow, noopener, noreferrer" target="_blank">Go by Example</a>, cercando di seguire anche la filosofia del Test-Driven Development (TDD).</p>
<p>Devo confessare di aver tralasciato alcuni argomenti (come channels, goroutine, …) che non erano così rilevanti per il mio progetto, ma su cui probabilmente tornerò in futuro, magari con altri progetti.</p>
<p>Mano a mano che la libreria prendeva forma e integravo le API di open-meteo.com ho deciso di raccogliere i dati meteorologici utilizzando le coordinate geografiche della mia zona e a archiviarli in PostgreSQL, così da poter utilizzare Grafana per creare un dashboard personalizzata.</p>
<h2 id="openmeteogo-client">Openmeteogo Client</h2>
<p>Tempo di creare un container per Postgres sul mio raspberry pi 4 in cui collezionare i dati, era ora di scrivere un client per la mia libreria.</p>
<p>Ho usato sempre Go e creato un progetto command line usando <a href="https://github.com/spf13/cobra" rel="nofollow, noopener, noreferrer" target="_blank">Cobra</a> e <a href="https://github.com/go-gorm/gorm" rel="nofollow, noopener, noreferrer" target="_blank">gorm</a> come ORM</p>
<p>Dockerizzata questa nuova cli e fatto partire il nuovo container sempre sul raspberry pi mi è bastato aggiungere un paio di righe nel crontab per vedere il mio postgres popolarsi</p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.500gk.css"><script type="module" src="/_astro/ec.sgewm.js"><\/script><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--0:#50FA7B;--1:#6F42C1">*/30</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">docker</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">exec</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">home_server-mymeteo-1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">sh</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">-c</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">./mymeteo current-weather 41.902291 12.457257</span><span style="--0:#E9F284">"</span></span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--0:#50FA7B;--1:#6F42C1">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F1FA8C;--1:#032F62">/2</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">docker</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">exec</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">home_server-mymeteo-1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">sh</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">-c</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">./mymeteo hourly-weather 41.902291 12.457257 2</span><span style="--0:#E9F284">"</span></span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--0:#50FA7B;--1:#6F42C1">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F1FA8C;--1:#032F62">/4</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">docker</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">exec</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">home_server-mymeteo-1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">sh</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">-c</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">./mymeteo daily-weather 41.902291 12.457257 4</span><span style="--0:#E9F284">"</span></span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--0:#50FA7B;--1:#6F42C1">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F1FA8C;--1:#032F62">/6</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">docker</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">exec</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">home_server-mymeteo-1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">sh</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">-c</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">./mymeteo current-air-quality 41.902291 12.457257</span><span style="--0:#E9F284">"</span></span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--0:#50FA7B;--1:#6F42C1">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F1FA8C;--1:#032F62">/12</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">docker</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">exec</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">home_server-mymeteo-1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">sh</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">-c</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">./mymeteo hourly-air-quality 41.902291 12.457257 2</span><span style="--0:#E9F284">"</span></span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="*/30 * * * * docker exec home_server-mymeteo-1 sh -c &#x22;./mymeteo current-weather 41.902291 12.457257&#x22;    0 */2 * * * docker exec home_server-mymeteo-1 sh -c &#x22;./mymeteo hourly-weather 41.902291 12.457257 2&#x22;    0 */4 * * * docker exec home_server-mymeteo-1 sh -c &#x22;./mymeteo daily-weather 41.902291 12.457257 4&#x22;    0 */6 * * * docker exec home_server-mymeteo-1 sh -c &#x22;./mymeteo current-air-quality 41.902291 12.457257&#x22;    0 */12 * * * docker exec home_server-mymeteo-1 sh -c &#x22;./mymeteo hourly-air-quality 41.902291 12.457257 2&#x22;"><div></div></button></div></figure></div>
<br>
<h2 id="grafana">Grafana</h2>
<p>Finalmente Grafana aveva qualcosa da mostrare.</p>
<p>Le misurazioni del meteo corrente avevano preso forma
<img __ASTRO_IMAGE_="{&#x22;src&#x22;:&#x22;../../assets/go-weather/current_weather.png&#x22;,&#x22;alt&#x22;:&#x22;Meteo attuale&#x22;,&#x22;index&#x22;:0}"></p>
<p>Anche quelle giorno per giorno adesso hanno una dashboard dedicata
<img __ASTRO_IMAGE_="{&#x22;src&#x22;:&#x22;../../assets/go-weather/daily_weather.png&#x22;,&#x22;alt&#x22;:&#x22;Meteo attuale&#x22;,&#x22;index&#x22;:0}"></p>
<p>La dashboard delle previsioni orarie mi ha dato qualche noia ma alla fine eccola popolata
<img __ASTRO_IMAGE_="{&#x22;src&#x22;:&#x22;../../assets/go-weather/hourly_weather.png&#x22;,&#x22;alt&#x22;:&#x22;Meteo attuale&#x22;,&#x22;index&#x22;:0}"></p>
<p>E per ultima cosa, visto che siamo in stagione, la dashboard delle misurazioni di PM* e pollini
<img __ASTRO_IMAGE_="{&#x22;src&#x22;:&#x22;../../assets/go-weather/pm_and_pollen.png&#x22;,&#x22;alt&#x22;:&#x22;Meteo attuale&#x22;,&#x22;index&#x22;:0}"></p>`),ae={title:"Una dashboard meteo con Go e Grafana",description:"Sviluppo libreria Go per open-meteo.com",publishDate:"04 May 2024",updatedDate:"04 May 2024",tags:["go","grafana"],minutesRead:"2 min read"},te="/home/io/Documents/code/ophusdev-blog/src/content/post/go-weather.md",ne=void 0;function pe(){return`
## Openmeteogo

Nelle ultime settimane mi sono immerso nell'utilizzo di Go per sviluppare una libreria per [open-meteo.com](http://open-meteo.com), ora disponibile su [Github](https://github.com/ophusdev/openmeteogo) che ho nominato openmeteogo.

Come primo approccio a Go, mi sono affidato interamente a [Go by Example](https://gobyexample.com/), cercando di seguire anche la filosofia del Test-Driven Development (TDD).

Devo confessare di aver tralasciato alcuni argomenti (come channels, goroutine, ...) che non erano così rilevanti per il mio progetto, ma su cui probabilmente tornerò in futuro, magari con altri progetti.

Mano a mano che la libreria prendeva forma e integravo le API di open-meteo.com ho deciso di raccogliere i dati meteorologici utilizzando le coordinate geografiche della mia zona e a archiviarli in PostgreSQL, così da poter utilizzare Grafana per creare un dashboard personalizzata.

## Openmeteogo Client

Tempo di creare un container per Postgres sul mio raspberry pi 4 in cui collezionare i dati, era ora di scrivere un client per la mia libreria.

Ho usato sempre Go e creato un progetto command line usando [Cobra](https://github.com/spf13/cobra) e [gorm](https://github.com/go-gorm/gorm) come ORM

Dockerizzata questa nuova cli e fatto partire il nuovo container sempre sul raspberry pi mi è bastato aggiungere un paio di righe nel crontab per vedere il mio postgres popolarsi

\`\`\`bash
    */30 * * * * docker exec home_server-mymeteo-1 sh -c "./mymeteo current-weather 41.902291 12.457257"
    0 */2 * * * docker exec home_server-mymeteo-1 sh -c "./mymeteo hourly-weather 41.902291 12.457257 2"
    0 */4 * * * docker exec home_server-mymeteo-1 sh -c "./mymeteo daily-weather 41.902291 12.457257 4"
    0 */6 * * * docker exec home_server-mymeteo-1 sh -c "./mymeteo current-air-quality 41.902291 12.457257"
    0 */12 * * * docker exec home_server-mymeteo-1 sh -c "./mymeteo hourly-air-quality 41.902291 12.457257 2"
\`\`\`

<br />

## Grafana

Finalmente Grafana aveva qualcosa da mostrare.

Le misurazioni del meteo corrente avevano preso forma
![Meteo attuale](../../assets/go-weather/current_weather.png)

Anche quelle giorno per giorno adesso hanno una dashboard dedicata
![Meteo attuale](../../assets/go-weather/daily_weather.png)

La dashboard delle previsioni orarie mi ha dato qualche noia ma alla fine eccola popolata
![Meteo attuale](../../assets/go-weather/hourly_weather.png)

E per ultima cosa, visto che siamo in stagione, la dashboard delle misurazioni di PM\\* e pollini
![Meteo attuale](../../assets/go-weather/pm_and_pollen.png)
`}function le(){return z}function ce(){return[{depth:2,slug:"openmeteogo",text:"Openmeteogo"},{depth:2,slug:"openmeteogo-client",text:"Openmeteogo Client"},{depth:2,slug:"grafana",text:"Grafana"}]}const me=_((e,n,s)=>{const{layout:a,...t}=ae;return t.file=te,t.url=ne,f`${w()}${$(z)}`});export{me as Content,le as compiledContent,me as default,te as file,ae as frontmatter,ce as getHeadings,pe as rawContent,ne as url};
