<!DOCTYPE html><html lang="it-IT"> <head><meta charset="utf-8"><meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport"><meta content="IE=edge" http-equiv="X-UA-Compatible"><title>Postgres: Race Condition, Unique Constraints and Handling Concurrency • OphusDev blog</title><link href="/favicon.ico" rel="icon" sizes="any"><link href="/apple-touch-icon.png" rel="apple-touch-icon"><link href="/manifest.webmanifest" rel="manifest"><link href="https://ophusdev.github.io/posts/postgres-race-condition-and-unique-constraint/" rel="canonical"><meta content="Postgres: Race Condition, Unique Constraints and Handling Concurrency • OphusDev blog" name="title"><meta content="Come gestire le ace conditions e gli unique constraints in Postgres, utilizzando ON CONFLICT DO NOTHING per prevenire record duplicati" name="description"><meta content="OphusDev" name="author"><meta content="" name="theme-color"><meta content="article" property="og:type"><meta content="Postgres: Race Condition, Unique Constraints and Handling Concurrency" property="og:title"><meta content="Come gestire le ace conditions e gli unique constraints in Postgres, utilizzando ON CONFLICT DO NOTHING per prevenire record duplicati" property="og:description"><meta content="https://ophusdev.github.io/posts/postgres-race-condition-and-unique-constraint/" property="og:url"><meta content="OphusDev blog" property="og:site_name"><meta content="it_IT" property="og:locale"><meta content="https://ophusdev.github.io/og-image/postgres-race-condition-and-unique-constraint.png" property="og:image"><meta content="1200" property="og:image:width"><meta content="630" property="og:image:height"><meta content="OphusDev" property="article:author"><meta content="2024-12-06T23:00:00.000Z" property="article:published_time"><meta content="summary_large_image" property="twitter:card"><meta content="https://ophusdev.github.io/posts/postgres-race-condition-and-unique-constraint/" property="twitter:url"><meta content="Postgres: Race Condition, Unique Constraints and Handling Concurrency" property="twitter:title"><meta content="Come gestire le ace conditions e gli unique constraints in Postgres, utilizzando ON CONFLICT DO NOTHING per prevenire record duplicati" property="twitter:description"><meta content="https://ophusdev.github.io/og-image/postgres-race-condition-and-unique-constraint.png" property="twitter:image"><link href="/sitemap-index.xml" rel="sitemap"><link href="/rss.xml" rel="alternate" title="OphusDev blog" type="application/rss+xml"><link href="" rel="webmention"><meta content="Astro v4.2.4" name="generator"><link rel="stylesheet" href="/_astro/_slug_.8NV-i0vi.css" /><script type="module" src="/_astro/hoisted.-qp7XOvm.js"></script>
<script type="module" src="/_astro/page.BG5lM7_G.js"></script></head> <body> <script>
	const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

	function getUserPref() {
		const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
		return storedTheme || (lightModePref.matches ? "dark" : "light");
	}

	function setTheme(newTheme) {
		if (newTheme !== "light" && newTheme !== "dark") {
			return console.warn(
				`Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
			);
		}

		const root = document.documentElement;

		// root already set to newTheme, exit early
		if (newTheme === root.getAttribute("data-theme")) {
			return;
		}

		root.setAttribute("data-theme", newTheme);

		const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
		const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
		colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
		if (typeof localStorage !== "undefined") {
			localStorage.setItem("theme", newTheme);
		}
	}

	// initial setup
	setTheme(getUserPref());

	// View Transitions hook to restore theme
	document.addEventListener("astro:after-swap", () => setTheme(getUserPref()));

	// listen for theme-change custom event, fired in src/components/ThemeToggle.astro
	document.addEventListener("theme-change", (e) => {
		setTheme(e.detail.theme);
	});

	// listen for prefers-color-scheme change.
	lightModePref.addEventListener("change", (e) => setTheme(e.matches ? "dark" : "light"));
</script> <a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">skip to content
</a> <header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header"> <div class="flex sm:flex-col"> <a class="inline-flex items-center grayscale hover:filter-none sm:relative sm:inline-block" href="/"> <span class="text-xl font-bold sm:text-2xl">OphusDev</span> </a> <nav aria-label="Main menu" class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none" id="navigation-menu"> <a class="px-4 py-4 sm:py-0 sm:hover:underline" data-astro-prefetch href="/"> Home </a><a class="px-4 py-4 sm:py-0 sm:hover:underline" data-astro-prefetch href="/about/"> About </a><a class="px-4 py-4 sm:py-0 sm:hover:underline" data-astro-prefetch href="/posts/"> Blog </a> </nav> </div> <site-search class="ms-auto" id="search" data-astro-cid-otpdt6jm> <button class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2" data-open-modal disabled data-astro-cid-otpdt6jm> <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <path d="M0 0h24v24H0z" stroke="none" data-astro-cid-otpdt6jm></path> <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6" data-astro-cid-otpdt6jm></path> </svg> </button> <dialog aria-label="search" class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md" data-astro-cid-otpdt6jm> <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6" data-astro-cid-otpdt6jm> <button class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700" data-close-modal data-astro-cid-otpdt6jm>Close</button> <div class="search-container" data-astro-cid-otpdt6jm> <div id="cactus__search" data-astro-cid-otpdt6jm></div> </div> </div> </dialog> </site-search>    <theme-toggle class="ms-2 sm:ms-4"> <button class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2" type="button"> <span class="sr-only">Dark Theme</span> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0" fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> </svg> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100" fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" fill="none" stroke="none"></path> <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path> <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path> <path d="M19 11h2m-1 -1v2"></path> </svg> </button> </theme-toggle>  <mobile-button> <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu" class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button"> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0" fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100" class="text-accent" fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button> </mobile-button> </header>  <main id="main">  <div class="gap-x-10 lg:flex lg:items-start"> <aside class="sticky top-20 order-2 -me-32 hidden basis-64 lg:block"> <h2 class="font-semibold">Table of Contents</h2> <ul class="mt-4 text-xs"> <li class=""> <a aria-label="Scroll to section: Iniziamo" class="block line-clamp-2 hover:text-accent mt-3" href="#iniziamo"><span class="me-0.5">#</span>Iniziamo</a>  </li><li class=""> <a aria-label="Scroll to section: La nostra query" class="block line-clamp-2 hover:text-accent mt-3" href="#la-nostra-query"><span class="me-0.5">#</span>La nostra query</a>  </li><li class=""> <a aria-label="Scroll to section: Simuliamo una scrittura concorrenziale" class="block line-clamp-2 hover:text-accent mt-3" href="#simuliamo-una-scrittura-concorrenziale"><span class="me-0.5">#</span>Simuliamo una scrittura concorrenziale</a>  </li><li class=""> <a aria-label="Scroll to section: La soluzione" class="block line-clamp-2 hover:text-accent mt-3" href="#la-soluzione"><span class="me-0.5">#</span>La soluzione</a>  </li><li class=""> <a aria-label="Scroll to section: Scenario Bonus" class="block line-clamp-2 hover:text-accent mt-3" href="#scenario-bonus"><span class="me-0.5">#</span>Scenario Bonus</a>  </li><li class=""> <a aria-label="Scroll to section: SQLAlchemy Query" class="block line-clamp-2 hover:text-accent mt-3" href="#sqlalchemy-query"><span class="me-0.5">#</span>SQLAlchemy Query</a>  </li> </ul> </aside> <article class="flex-grow break-words" data-pagefind-body> <div id="blog-hero"><h1 class="title mb-3 sm:mb-1"> Postgres: Race Condition, Unique Constraints and Handling Concurrency </h1> <div class="flex flex-wrap items-center gap-x-3 gap-y-2"> <p class="font-semibold"> <time datetime="2024-12-06T23:00:00.000Z"> 7 dicembre 2024 </time> /  5 min read </p> <span class="rounded-lg bg-quote/10 p-1 text-quote">
Last Updated:
<time datetime="2024-12-06T23:00:00.000Z" class="ms-1"> 7 dicembre 2024 </time> </span> </div> <div class="mt-3"> <svg aria-hidden="true" class="me-1 inline-block h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" fill="none" stroke="none"></path> <path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path> <path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path> <path d="M6 9h-.01"></path> </svg> <a aria-label="View more blogs with the tag postgres" class="cactus-link inline-block before:content-['#']" data-pagefind-filter="tag" href="/tags/postgres/">postgres</a> , <a aria-label="View more blogs with the tag python" class="cactus-link inline-block before:content-['#']" data-pagefind-filter="tag" href="/tags/python/">python</a> , <a aria-label="View more blogs with the tag race condition" class="cactus-link inline-block before:content-['#']" data-pagefind-filter="tag" href="/tags/race condition/">race condition</a>  </div></div> <div class="prose prose-sm prose-cactus mt-12 prose-headings:font-semibold prose-headings:text-accent-2 prose-headings:before:absolute prose-headings:before:-ms-4 prose-headings:before:text-accent prose-headings:before:content-['#'] prose-th:before:content-none">  <p>Mi sono trovato davanti ad un problema di race condition su Postgres in un processo che doveva importare migliaia di record in parallelo con il risultato che sul database mi ritrovavo con decine di record duplicati.</p>
<p>Le tecnologie coinvolte sono Python3.11, SQLAlchemy 2.0.36 e Postgres 17.2 ma in questo post ricreeremo la situazione con TSQL e un paio di terminali per non avere troppe dipendenze esterne.</p>
<p>Alla fine del post si può trovare il paragrafo con la query tradotta nella sintassi di SQLAlchemy.</p>
<h2 id="iniziamo">Iniziamo</h2>
<p>Avviamo un postgres usando Docker con un semplice <code>docker compose up -d</code></p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.500gk.css"><script type="module" src="/_astro/ec.sgewm.js"></script><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#8BE9FD;--1:#1E7734">services</span><span style="--0:#FF79C6;--1:#24292E">:</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#8BE9FD;--1:#1E7734">postgres</span><span style="--0:#FF79C6;--1:#24292E">:</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--0:#8BE9FD;--1:#1E7734">image</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#F1FA8C;--1:#032F62">postgres:17.2</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--0:#8BE9FD;--1:#1E7734">ports</span><span style="--0:#FF79C6;--1:#24292E">:</span></div><div class="ec-line"><span style="--1:#24292E"><span style="--0:#F8F8F2">      </span><span style="--0:#FF79C6">-</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#F1FA8C;--1:#032F62">5432:5432</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--0:#8BE9FD;--1:#1E7734">environment</span><span style="--0:#FF79C6;--1:#24292E">:</span></div><div class="ec-line"><span style="--1:#24292E"><span style="--0:#F8F8F2">      </span><span style="--0:#FF79C6">-</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#F1FA8C;--1:#032F62">POSTGRES_DB=people</span></div><div class="ec-line"><span style="--1:#24292E"><span style="--0:#F8F8F2">      </span><span style="--0:#FF79C6">-</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#F1FA8C;--1:#032F62">POSTGRES_USER=user</span></div><div class="ec-line"><span style="--1:#24292E"><span style="--0:#F8F8F2">      </span><span style="--0:#FF79C6">-</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#F1FA8C;--1:#032F62">POSTGRES_PASSWORD=dev</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="services:  postgres:    image: postgres:17.2    ports:      - 5432:5432    environment:      - POSTGRES_DB=people      - POSTGRES_USER=user      - POSTGRES_PASSWORD=dev"><div></div></button></div></figure></div>
<p>e connettiamoci con una shell</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#50FA7B;--1:#6F42C1">psql</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">postgresql://user:dev@localhost/people</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="psql postgresql://user:dev@localhost/people"><div></div></button></div></figure></div>
<p>Creiamo la tabella per il nostro esperimento</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">CREATE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">TABLE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">people</span><span style="--0:#F8F8F2;--1:#24292E"> (</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    id </span><span style="--0:#FF79C6;--1:#BF3441">SERIAL</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">NOT NULL</span><span style="--0:#F8F8F2;--1:#24292E">,</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    fiscal_code </span><span style="--0:#FF79C6;--1:#BF3441">VARCHAR</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">16</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">NOT NULL</span><span style="--0:#F8F8F2;--1:#24292E">,</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    first_name </span><span style="--0:#FF79C6;--1:#BF3441">VARCHAR</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">255</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">NOT NULL</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">);</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="CREATE TABLE people (    id SERIAL NOT NULL,    fiscal_code VARCHAR(16) NOT NULL,    first_name VARCHAR(255) NOT NULL);"><div></div></button></div></figure></div>
<p>Inseriamo un paio di dati</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">BEGIN</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">INSERT INTO</span><span style="--0:#F8F8F2;--1:#24292E"> people (fiscal_code, first_name) </span><span style="--0:#FF79C6;--1:#BF3441">VALUES</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">AAA</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">Pippo</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">INSERT INTO</span><span style="--0:#F8F8F2;--1:#24292E"> people (fiscal_code, first_name) </span><span style="--0:#FF79C6;--1:#BF3441">VALUES</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">BBB</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">Pluto</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">COMMIT</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="BEGIN;INSERT INTO people (fiscal_code, first_name) VALUES (&#x27;AAA&#x27;, &#x27;Pippo&#x27;);INSERT INTO people (fiscal_code, first_name) VALUES (&#x27;BBB&#x27;, &#x27;Pluto&#x27;);COMMIT;"><div></div></button></div></figure></div>
<p>Controlliamo la nostra tabella</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">SELECT</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">FROM</span><span style="--0:#F8F8F2;--1:#24292E"> people;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">id | fiscal_code | first_name</span></div><div class="ec-line"><span style="--0:#96A1C2;--1:#616972">----+-------------+------------</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E"> | AAA         | Pippo</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E"> | BBB         | Pluto</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">rows</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="SELECT * FROM people;id | fiscal_code | first_name----+-------------+------------  1 | AAA         | Pippo  2 | BBB         | Pluto(2 rows)"><div></div></button></div></figure></div>
<h2 id="la-nostra-query">La nostra query</h2>
<p>Adesso usiamo il costrutto INSERT INTO SELECT per inserire un nuovo record senza dover fare prima una query per testare l’esistenza del record e otteniamo che nessuna riga viene inserita poichè esiste già un record identico</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">INSERT INTO</span><span style="--0:#F8F8F2;--1:#24292E"> people (fiscal_code, first_name)</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">SELECT</span></div><div class="ec-line"><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">AAA</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">,</span></div><div class="ec-line"><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">Pippo</span><span style="--0:#E9F284">'</span></span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">WHERE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">NOT</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">EXISTS</span><span style="--0:#F8F8F2;--1:#24292E"> (</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">        </span><span style="--0:#FF79C6;--1:#BF3441">SELECT</span><span style="--0:#F8F8F2;--1:#24292E"> fiscal_code, first_name</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">            </span><span style="--0:#FF79C6;--1:#BF3441">FROM</span><span style="--0:#F8F8F2;--1:#24292E"> people</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">            </span><span style="--0:#FF79C6;--1:#BF3441">WHERE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">people</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#BD93F9;--1:#005CC5">fiscal_code</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">AAA</span><span style="--0:#E9F284">'</span></span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">            </span><span style="--0:#FF79C6;--1:#BF3441">AND</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">people</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#BD93F9;--1:#005CC5">first_name</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">Pippo</span><span style="--0:#E9F284">'</span></span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">        )</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">RETURNING </span><span style="--0:#BD93F9;--1:#005CC5">people</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#BD93F9;--1:#005CC5">id</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#BD93F9;--1:#005CC5">people</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#BD93F9;--1:#005CC5">fiscal_code</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#BD93F9;--1:#005CC5">people</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#BD93F9;--1:#005CC5">first_name</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="INSERT INTO people (fiscal_code, first_name)SELECT&#x27;AAA&#x27;,&#x27;Pippo&#x27;WHERE NOT EXISTS (        SELECT fiscal_code, first_name            FROM people            WHERE people.fiscal_code = &#x27;AAA&#x27;            AND people.first_name = &#x27;Pippo&#x27;        )RETURNING people.id, people.fiscal_code, people.first_name;"><div></div></button></div></figure></div>
<p>Infatti la risposta che otteniamo dopo l’insert è</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">id | fiscal_code | first_name</span></div><div class="ec-line"><span style="--0:#96A1C2;--1:#616972">----+-------------+------------</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">rows</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">INSERT</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="id | fiscal_code | first_name----+-------------+------------(0 rows)INSERT 0 0"><div></div></button></div></figure></div>
<p>Puliamo la nostra tabella</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">DELETE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">FROM</span><span style="--0:#F8F8F2;--1:#24292E"> people;</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="DELETE FROM people;"><div></div></button></div></figure></div>
<h2 id="simuliamo-una-scrittura-concorrenziale">Simuliamo una scrittura concorrenziale</h2>
<p>Apriamo due nuove shell sul terminale e connettiamoci al database</p>
<p>Per simulare la concorrenza usiamo questo trucco:</p>








































<table><thead><tr><th align="center"><strong>Step</strong></th><th align="center"><strong>Shell di sinistra</strong></th><th align="center"><strong>Shell di destra</strong></th></tr></thead><tbody><tr><td align="center">1</td><td align="center">digitiamo <code>BEGIN;</code></td><td align="center"></td></tr><tr><td align="center">2</td><td align="center"></td><td align="center">digitiamo <code>BEGIN;</code></td></tr><tr><td align="center">3</td><td align="center"><a href="#la-nostra-query">Copiamo ed eseguiamo la nostra query</a></td><td align="center"></td></tr><tr><td align="center">4</td><td align="center"></td><td align="center"><a href="#la-nostra-query">Copiamo ed eseguiamo la nostra query</a></td></tr><tr><td align="center">5</td><td align="center">digitiamo <code>COMMIT</code></td><td align="center"></td></tr><tr><td align="center">6</td><td align="center"></td><td align="center">digitiamo <code>COMMIT</code></td></tr></tbody></table>
<p>Eseguiamo lo step 1 nella shell di sinistra e lo step 2 nella shell di destra</p>
<p>Ora eseguiamo lo step 3 nella shell di sinistra e riceveremo sul terminale la risposta <code>INSERT 0 1</code> ma la transazione non è ancora commitata quindi sul database noi non abbiamo ancora scritto nessun record.</p>
<p>Ora eseguiamo lo step 4 e dato che è postgres a preoccuparsi del lock sul record ed essendo la insert una operazione che esegue il lock prima di effettuare cambiamenti ci aspettiamo che la shell rimanga in attesa che l’altra transazione si chiuda … e invece eseguendo la query anche la seconda shell ci restituisce <code>INSERT 0 1</code></p>
<p>Eseguiamo gli step 5 e 6 per concludere le due transazioni</p>
<p>La <a href="#la-nostra-query">nostra query</a> con il suo where non è bloccante quindi ci porta ad un problema di race condition da cui non siamo protetti nel caso di concorrenzialità e ci troviamo con i record duplicati</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">SELECT</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">FROM</span><span style="--0:#F8F8F2;--1:#24292E"> people;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">id | fiscal_code | first_name</span></div><div class="ec-line"><span style="--0:#96A1C2;--1:#616972">----+-------------+------------</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">3</span><span style="--0:#F8F8F2;--1:#24292E"> | AAA         | Pippo</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">4</span><span style="--0:#F8F8F2;--1:#24292E"> | AAA         | Pippo</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">rows</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="SELECT * FROM people;id | fiscal_code | first_name----+-------------+------------  3 | AAA         | Pippo  4 | AAA         | Pippo(2 rows)"><div></div></button></div></figure></div>
<h2 id="la-soluzione">La soluzione</h2>
<p>Ci viene in aiuto un paragrafo della documentazione di <a href="https://www.postgresql.org/docs/current/sql-insert.html" rel="nofollow, noopener, noreferrer" target="_blank">Postgres</a> che riporta</p>
<blockquote>
<p>INSERT into tables that lack unique indexes will not be blocked by concurrent activity. Tables with unique indexes might block if concurrent sessions perform actions that lock or modify rows matching the unique index values being inserted; the details are covered in Section 62.5. ON CONFLICT can be used to specify an alternative action to raising a unique constraint or exclusion constraint violation error. (See ON CONFLICT Clause below.)</p>
</blockquote>
<p>Dobbiamo creare un indice univoco per fare in modo che Postgres ci permetta di proteggerci da scritture concorrenti</p>
<p>Puliamo di nuovo la tabella con</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">DELETE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">FROM</span><span style="--0:#F8F8F2;--1:#24292E"> people;</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="DELETE FROM people;"><div></div></button></div></figure></div>
<p>e creiamo l’indice</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">ALTER</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">TABLE</span><span style="--0:#F8F8F2;--1:#24292E"> ONLY people </span><span style="--0:#FF79C6;--1:#BF3441">ADD</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">CONSTRAINT</span><span style="--0:#F8F8F2;--1:#24292E"> uq_people_fiscal_code_first_name </span><span style="--0:#FF79C6;--1:#BF3441">UNIQUE</span><span style="--0:#F8F8F2;--1:#24292E"> (fiscal_code, first_name);</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="ALTER TABLE ONLY people ADD CONSTRAINT uq_people_fiscal_code_first_name UNIQUE (fiscal_code, first_name);"><div></div></button></div></figure></div>
<p>Adesso, ripetendo i passaggi del paragrafo <a href="#simuliamo-una-scrittura-concorrenziale">Simuliamo una scrittura concorrenziale</a> e otteniamo che nella seconda shell rimarremo in attesa finche dalla prima non effettueremo un rollback
o una commit;</p>
<p>Tutto perfetto ma nella seconda shell otteniamo un messaggio di errore</p>
<blockquote>
<p>ERROR: duplicate key value violates unique constraint “uq_people_fiscal_code_first_name”
DETAIL: Key (fiscal_code, first_name)=(AAA, Pippo) already exists.</p>
</blockquote>
<p>Prima puliamo la tabella</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">DELETE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">from</span><span style="--0:#F8F8F2;--1:#24292E"> people;</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="DELETE from people;"><div></div></button></div></figure></div>
<p>Serve una piccola modifica alla nostra query aggiungendo la clausola <code>ON CONFLICT DO NOTHING</code> e possiamo riprodurre di nuovo i passaggi del paragrafo <a href="#simuliamo-una-scrittura-concorrenziale">Simuliamo una scrittura concorrenziale</a></p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">INSERT INTO</span><span style="--0:#F8F8F2;--1:#24292E"> people (fiscal_code, first_name)</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">SELECT</span></div><div class="ec-line"><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">AAA</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">,</span></div><div class="ec-line"><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">Pippo</span><span style="--0:#E9F284">'</span></span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">WHERE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">NOT</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">EXISTS</span><span style="--0:#F8F8F2;--1:#24292E"> (</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">        </span><span style="--0:#FF79C6;--1:#BF3441">SELECT</span><span style="--0:#F8F8F2;--1:#24292E"> fiscal_code, first_name</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">            </span><span style="--0:#FF79C6;--1:#BF3441">FROM</span><span style="--0:#F8F8F2;--1:#24292E"> people</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">            </span><span style="--0:#FF79C6;--1:#BF3441">WHERE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">people</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#BD93F9;--1:#005CC5">fiscal_code</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">AAA</span><span style="--0:#E9F284">'</span></span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">            </span><span style="--0:#FF79C6;--1:#BF3441">AND</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">people</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#BD93F9;--1:#005CC5">first_name</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">Pippo</span><span style="--0:#E9F284">'</span></span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">        )</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">ON</span><span style="--0:#F8F8F2;--1:#24292E"> CONFLICT DO NOTHING</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">RETURNING </span><span style="--0:#BD93F9;--1:#005CC5">people</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#BD93F9;--1:#005CC5">id</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#BD93F9;--1:#005CC5">people</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#BD93F9;--1:#005CC5">fiscal_code</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#BD93F9;--1:#005CC5">people</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#BD93F9;--1:#005CC5">first_name</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="INSERT INTO people (fiscal_code, first_name)SELECT&#x27;AAA&#x27;,&#x27;Pippo&#x27;WHERE NOT EXISTS (        SELECT fiscal_code, first_name            FROM people            WHERE people.fiscal_code = &#x27;AAA&#x27;            AND people.first_name = &#x27;Pippo&#x27;        )ON CONFLICT DO NOTHINGRETURNING people.id, people.fiscal_code, people.first_name;"><div></div></button></div></figure></div>
<p>Controlliamo il nostro risultato</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">SELECT</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">from</span><span style="--0:#F8F8F2;--1:#24292E"> people;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E"> id | fiscal_code | first_name</span></div><div class="ec-line"><span style="--0:#96A1C2;--1:#616972">----+-------------+------------</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">7</span><span style="--0:#F8F8F2;--1:#24292E"> | AAA         | Pippo</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">row</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="SELECT * from people; id | fiscal_code | first_name----+-------------+------------  7 | AAA         | Pippo(1 row)"><div></div></button></div></figure></div>
<h2 id="scenario-bonus">Scenario Bonus</h2>
<p>E se avessimo uno dei campi della tabella che fosse nullable?</p>
<p>Facciamo una prova</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">DROP</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">TABLE</span><span style="--0:#F8F8F2;--1:#24292E"> people;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">CREATE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">TABLE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">people</span><span style="--0:#F8F8F2;--1:#24292E"> (</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    id </span><span style="--0:#FF79C6;--1:#BF3441">SERIAL</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">NOT null</span><span style="--0:#F8F8F2;--1:#24292E">,</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    fiscal_code </span><span style="--0:#FF79C6;--1:#BF3441">VARCHAR</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">16</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">NOT null</span><span style="--0:#F8F8F2;--1:#24292E">,</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    first_name </span><span style="--0:#FF79C6;--1:#BF3441">VARCHAR</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">255</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">NOT null</span><span style="--0:#F8F8F2;--1:#24292E">,</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    birth_date </span><span style="--0:#FF79C6;--1:#BF3441">timestamptz</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">NULL</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">ALTER</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">TABLE</span><span style="--0:#F8F8F2;--1:#24292E"> ONLY people </span><span style="--0:#FF79C6;--1:#BF3441">ADD</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">CONSTRAINT</span><span style="--0:#F8F8F2;--1:#24292E"> uq_people_fiscal_code_first_name_birth_date </span><span style="--0:#FF79C6;--1:#BF3441">UNIQUE</span><span style="--0:#F8F8F2;--1:#24292E"> (fiscal_code, first_name, birth_date);</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="DROP TABLE people;CREATE TABLE people (    id SERIAL NOT null,    fiscal_code VARCHAR(16) NOT null,    first_name VARCHAR(255) NOT null,    birth_date timestamptz NULL);ALTER TABLE ONLY people ADD CONSTRAINT uq_people_fiscal_code_first_name_birth_date UNIQUE (fiscal_code, first_name, birth_date);"><div></div></button></div></figure></div>
<p>Inseriamo due righe</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">INSERT INTO</span><span style="--0:#F8F8F2;--1:#24292E"> people (fiscal_code, first_name, birth_date) </span><span style="--0:#FF79C6;--1:#BF3441">VALUES</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">AAA</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">Pippo</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#FF79C6;--1:#BF3441">NULL</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">INSERT INTO</span><span style="--0:#F8F8F2;--1:#24292E"> people (fiscal_code, first_name, birth_date) </span><span style="--0:#FF79C6;--1:#BF3441">VALUES</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">AAA</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">Pippo</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#FF79C6;--1:#BF3441">NULL</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="INSERT INTO people (fiscal_code, first_name, birth_date) VALUES (&#x27;AAA&#x27;, &#x27;Pippo&#x27;, NULL);INSERT INTO people (fiscal_code, first_name, birth_date) VALUES (&#x27;AAA&#x27;, &#x27;Pippo&#x27;, NULL);"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">SELECT</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">*</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">FROM</span><span style="--0:#F8F8F2;--1:#24292E"> people;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">id | fiscal_code | first_name | birth_date</span></div><div class="ec-line"><span style="--0:#96A1C2;--1:#616972">----+-------------+------------+------------</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E"> | AAA         | Pippo      |</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E"> | AAA         | Pippo      |</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">rows</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="SELECT * FROM people;id | fiscal_code | first_name | birth_date----+-------------+------------+------------  1 | AAA         | Pippo      |  2 | AAA         | Pippo      |(2 rows)"><div></div></button></div></figure></div>
<p>Il nostro unique constraint non si è attivato.</p>
<p>Questo perchè da Postgres 15 è necessario usare la clausola <code>NULLS NOT DISTINCT</code> che permette a Postgres di evitare di trattare i null come chiavi distinte.</p>
<p>Applichiamo le modifiche</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">DELETE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">FROM</span><span style="--0:#F8F8F2;--1:#24292E"> people;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">ALTER</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">TABLE</span><span style="--0:#F8F8F2;--1:#24292E"> people </span><span style="--0:#FF79C6;--1:#BF3441">DROP</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">CONSTRAINT</span><span style="--0:#F8F8F2;--1:#24292E"> uq_people_fiscal_code_first_name_birth_date;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">ALTER</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">TABLE</span><span style="--0:#F8F8F2;--1:#24292E"> ONLY people </span><span style="--0:#FF79C6;--1:#BF3441">ADD</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">CONSTRAINT</span><span style="--0:#F8F8F2;--1:#24292E"> uq_people_fiscal_code_first_name_birth_date </span><span style="--0:#FF79C6;--1:#BF3441">UNIQUE</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">NULLS</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">NOT</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">DISTINCT</span><span style="--0:#F8F8F2;--1:#24292E"> (fiscal_code, first_name, birth_date);</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="DELETE FROM people;ALTER TABLE people DROP CONSTRAINT uq_people_fiscal_code_first_name_birth_date;ALTER TABLE ONLY people ADD CONSTRAINT uq_people_fiscal_code_first_name_birth_date UNIQUE NULLS NOT DISTINCT (fiscal_code, first_name, birth_date);"><div></div></button></div></figure></div>
<p>E questa volta un solo record viene inserito mentre il secondo darà errore</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">INSERT INTO</span><span style="--0:#F8F8F2;--1:#24292E"> people (fiscal_code, first_name, birth_date) </span><span style="--0:#FF79C6;--1:#BF3441">VALUES</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">AAA</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">Pippo</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#FF79C6;--1:#BF3441">NULL</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">INSERT INTO</span><span style="--0:#F8F8F2;--1:#24292E"> people (fiscal_code, first_name, birth_date) </span><span style="--0:#FF79C6;--1:#BF3441">VALUES</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">AAA</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">Pippo</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#FF79C6;--1:#BF3441">NULL</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="INSERT INTO people (fiscal_code, first_name, birth_date) VALUES (&#x27;AAA&#x27;, &#x27;Pippo&#x27;, NULL);INSERT INTO people (fiscal_code, first_name, birth_date) VALUES (&#x27;AAA&#x27;, &#x27;Pippo&#x27;, NULL);"><div></div></button></div></figure></div>
<h2 id="sqlalchemy-query">SQLAlchemy Query</h2>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#50FA7B;--1:#6F42C1">virtualenv</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">.venv</span></div><div class="ec-line"><span style="--0:#8BE9FD;--1:#005CC5">.</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">.venv/bin/activate</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#50FA7B;--1:#6F42C1">pip</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">install</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">sqlalchemy==</span><span style="--0:#BD93F9;--1:#005CC5">2.0</span><span style="--0:#F1FA8C;--1:#032F62">.36</span></div><div class="ec-line"><span style="--0:#50FA7B;--1:#6F42C1">pip</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">install</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">psycopg2-binary==</span><span style="--0:#BD93F9;--1:#005CC5">2.9</span><span style="--0:#F1FA8C;--1:#032F62">.10</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="virtualenv .venv. .venv/bin/activatepip install sqlalchemy==2.0.36pip install psycopg2-binary==2.9.10"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">from</span><span style="--0:#F8F8F2;--1:#24292E"> sqlalchemy.dialects.postgresql </span><span style="--0:#FF79C6;--1:#BF3441">import</span><span style="--0:#F8F8F2;--1:#24292E"> insert</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">from</span><span style="--0:#F8F8F2;--1:#24292E"> sqlalchemy </span><span style="--0:#FF79C6;--1:#BF3441">import</span><span style="--0:#F8F8F2;--1:#24292E"> create_engine</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">from</span><span style="--0:#F8F8F2;--1:#24292E"> sqlalchemy.orm </span><span style="--0:#FF79C6;--1:#BF3441">import</span><span style="--0:#F8F8F2;--1:#24292E"> DeclarativeBase</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">from</span><span style="--0:#F8F8F2;--1:#24292E"> sqlalchemy.sql.schema </span><span style="--0:#FF79C6;--1:#BF3441">import</span><span style="--0:#F8F8F2;--1:#24292E"> MetaData</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">from</span><span style="--0:#F8F8F2;--1:#24292E"> sqlalchemy </span><span style="--0:#FF79C6;--1:#BF3441">import</span><span style="--0:#F8F8F2;--1:#24292E"> UniqueConstraint</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">from</span><span style="--0:#F8F8F2;--1:#24292E"> sqlalchemy.orm </span><span style="--0:#FF79C6;--1:#BF3441">import</span><span style="--0:#F8F8F2;--1:#24292E"> Mapped, mapped_column</span></div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">from</span><span style="--0:#F8F8F2;--1:#24292E"> sqlalchemy.sql.sqltypes </span><span style="--0:#FF79C6;--1:#BF3441">import</span><span style="--0:#F8F8F2;--1:#24292E"> String</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">session_provider </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> create_engine(</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">postgresql://user:dev@localhost/people</span><span style="--0:#E9F284">"</span></span><span style="--0:#F8F8F2;--1:#24292E">,</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">future</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#BD93F9;--1:#005CC5">True</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">)</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">metadata_obj </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> MetaData()</span></div><div class="ec-line">
</div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">Base</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#6F42C1">DeclarativeBase</span><span style="--0:#F8F8F2;--1:#24292E">):</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    metadata </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> metadata_obj</span></div><div class="ec-line">
</div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">Person</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#6F42C1">Base</span><span style="--0:#F8F8F2;--1:#24292E">):</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    __tablename__ </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">people</span><span style="--0:#E9F284">"</span></span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    __table_args__ </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (UniqueConstraint(</span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">fiscal_code</span><span style="--0:#E9F284">"</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">first_name</span><span style="--0:#E9F284">"</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">name</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">uq_people_fiscal_code_first_name</span><span style="--0:#E9F284">"</span></span><span style="--0:#F8F8F2;--1:#24292E">),)</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--0:#8BE9FD;--1:#005CC5">id</span><span style="--0:#F8F8F2;--1:#24292E">: Mapped[</span><span style="--0:#8BE9FD;--0fs:italic;--1:#005CC5">int</span><span style="--0:#F8F8F2;--1:#24292E">] </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> mapped_column(</span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">primary_key</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#BD93F9;--1:#005CC5">True</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    fiscal_code: Mapped[</span><span style="--0:#8BE9FD;--0fs:italic;--1:#005CC5">str</span><span style="--0:#F8F8F2;--1:#24292E">] </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> mapped_column(String(</span><span style="--0:#BD93F9;--1:#005CC5">16</span><span style="--0:#F8F8F2;--1:#24292E">))</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    first_name: Mapped[</span><span style="--0:#8BE9FD;--0fs:italic;--1:#005CC5">str</span><span style="--0:#F8F8F2;--1:#24292E">] </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> mapped_column(String(</span><span style="--0:#BD93F9;--1:#005CC5">255</span><span style="--0:#F8F8F2;--1:#24292E">))</span></div><div class="ec-line">
</div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#FF79C6;--1:#BF3441">with</span><span style="--0:#F8F8F2;--1:#24292E"> session_provider.begin() </span><span style="--0:#FF79C6;--1:#BF3441">as</span><span style="--0:#F8F8F2;--1:#24292E"> db_session:</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    record </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">        insert(Person)</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">        .values(</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">            </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">fiscal_code</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">AAA</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">,</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">            </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">first_name</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--1:#032F62"><span style="--0:#E9F284">'</span><span style="--0:#F1FA8C">Pippo</span><span style="--0:#E9F284">'</span></span><span style="--0:#F8F8F2;--1:#24292E">,</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">        )</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">        .on_conflict_do_nothing(</span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">index_elements</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E">[</span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">fiscal_code</span><span style="--0:#E9F284">"</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--1:#032F62"><span style="--0:#E9F284">"</span><span style="--0:#F1FA8C">first_name</span><span style="--0:#E9F284">"</span></span><span style="--0:#F8F8F2;--1:#24292E">])</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">        .returning(Person)</span></div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    )</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F8F8F2;--1:#24292E">    </span><span style="--0:#8BE9FD;--1:#005CC5">print</span><span style="--0:#F8F8F2;--1:#24292E">(db_session.execute(record).scalar_one_or_none())</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="from sqlalchemy.dialects.postgresql import insertfrom sqlalchemy import create_enginefrom sqlalchemy.orm import DeclarativeBasefrom sqlalchemy.sql.schema import MetaDatafrom sqlalchemy import UniqueConstraintfrom sqlalchemy.orm import Mapped, mapped_columnfrom sqlalchemy.sql.sqltypes import Stringsession_provider = create_engine(    &#x22;postgresql://user:dev@localhost/people&#x22;,    future=True)metadata_obj = MetaData()class Base(DeclarativeBase):    metadata = metadata_objclass Person(Base):    __tablename__ = &#x22;people&#x22;    __table_args__ = (UniqueConstraint(&#x22;fiscal_code&#x22;, &#x22;first_name&#x22;, name=&#x22;uq_people_fiscal_code_first_name&#x22;),)    id: Mapped[int] = mapped_column(primary_key=True)    fiscal_code: Mapped[str] = mapped_column(String(16))    first_name: Mapped[str] = mapped_column(String(255))with session_provider.begin() as db_session:    record = (        insert(Person)        .values(            fiscal_code=&#x27;AAA&#x27;,            first_name=&#x27;Pippo&#x27;,        )        .on_conflict_do_nothing(index_elements=[&#x22;fiscal_code&#x22;, &#x22;first_name&#x22;])        .returning(Person)    )    print(db_session.execute(record).scalar_one_or_none())"><div></div></button></div></figure></div>   </div> </article> </div> <button aria-label="Back to Top" class="z-90 fixed bottom-8 end-4 flex h-10 w-10 translate-y-28 items-center justify-center rounded-full border-2 border-transparent bg-zinc-200 text-3xl opacity-0 transition-all duration-300 hover:border-zinc-400 data-[show=true]:translate-y-0 data-[show=true]:opacity-100 dark:bg-zinc-700 sm:end-8 sm:h-12 sm:w-12" data-show="false" id="to-top-btn"><svg aria-hidden="true" class="h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M4.5 15.75l7.5-7.5 7.5 7.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button>  </main> <footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs"> <div class="me-0 sm:me-4">
&copy; OphusDev 2024 </div> <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500"> <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/"> Home </a><a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a><a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/posts/"> Blog </a> </nav> </footer> </body></html> 